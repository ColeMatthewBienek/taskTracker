generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum CardActivityType {
  CREATED
  EDITED
  MOVED
  ARCHIVED
  UNARCHIVED
}

enum SpecStatus {
  DRAFT
  SAVED
}

model Board {
  id         String   @id @default(cuid())
  name       String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  columns    Column[]
  projects   Project[]
}

model Project {
  id          String   @id @default(cuid())
  boardId     String
  name        String
  keyPrefix   String
  description String   @default("")
  nextSeq     Int      @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  board       Board    @relation(fields: [boardId], references: [id], onDelete: Cascade)
  cards       Card[]
  spec        ProjectSpec?

  @@index([boardId, name])
  @@unique([boardId, keyPrefix])
}

model ProjectSpec {
  id          String     @id @default(cuid())
  projectId   String     @unique
  markdown    String     @default("")
  status      SpecStatus @default(DRAFT)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  project     Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model Column {
  id        String   @id @default(cuid())
  boardId   String
  name      String
  order     Int
  wipLimit  Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  board     Board    @relation(fields: [boardId], references: [id], onDelete: Cascade)
  cards     Card[]

  @@index([boardId, order])
}

model Card {
  id          String    @id @default(cuid())
  columnId    String
  order       Int

  projectId   String?
  keyCode     String?

  title       String
  description String    @default("")
  tags        Json?     // string[] stored as JSON
  priority    Priority  @default(MEDIUM)
  dueDate     DateTime?

  archived    Boolean   @default(false)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  column      Column    @relation(fields: [columnId], references: [id], onDelete: Cascade)
  project     Project?  @relation(fields: [projectId], references: [id], onDelete: SetNull)
  activities  CardActivity[]
  comments    CardComment[]

  @@index([columnId, archived, order])
  @@index([title])
  @@index([projectId, archived, order])
  @@unique([projectId, keyCode])
}

model CardActivity {
  id         String           @id @default(cuid())
  cardId     String
  type       CardActivityType
  actor      String
  timestamp  DateTime         @default(now())
  before     Json?
  after      Json?

  card       Card             @relation(fields: [cardId], references: [id], onDelete: Cascade)

  @@index([cardId, timestamp])
}

model CardComment {
  id        String   @id @default(cuid())
  cardId    String
  author    String
  body      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  card      Card     @relation(fields: [cardId], references: [id], onDelete: Cascade)

  @@index([cardId, createdAt])
}

